<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="preview">
    <div class="top-header">
      <span class="book-icon">ğŸ“˜</span>
      <span class="book-title">Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©</span>
    </div>

    <div class="toolbar">
      <button onclick="copyWithMeta()">ğŸ“‹ Ù†Ø³Ø® </button>
      <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:
      <button onclick="adjustFontSize(1)">+</button>
      <button onclick="adjustFontSize(-1)">âˆ’</button>
    </div>

    <div id="display-area" class="full-display">â† Ø§Ø®ØªØ± Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ù‡Ù†Ø§</div>

    <div class="nav-buttons">
      <button id="prev-btn" onclick="prevPage()" disabled>â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <div id="page-number">ğŸ“„ Ø§Ù„ØµÙØ­Ø© 1</div>
      <button id="next-btn" onclick="nextPage()" disabled>Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
    </div>
  </div>

  <div class="results">
    {% set total_matches = results | map(attribute='snippets') | map('length') | sum %}
    <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "{{ query }}" (Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: {{ total_matches }})</h2>
    {% if results %}
      {% for result in results %}
        <div class="result">
          <h3>{{ result.path.replace('.txt', '').replace('.json', '') }}</h3>
          <ul>
            {% for snip in result.snippets %}
              <li class="snippet" onclick='handleSnippetClick(this); loadBookPages({{ result.pages | tojson | safe }}, {{ snip.page_number }}); setBookTitle("{{ result.filename.rsplit('.', 1)[0] }}")'>
                <strong>{{ loop.index }}.</strong>
                <span style="color: #888;">ğŸ“„ ØµÙØ­Ø© {{ snip.page_number + 1 }}</span> -
                {{ snip.line | safe }}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    {% else %}
      <p>âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ "{{ query }}"</p>
    {% endif %}
  </div>

  <div class="sidebar">
    <h2>ğŸ“š Ø§Ù„ÙƒØªØ¨</h2>
    <form method="POST" action="/search">
      <input type="text" name="query" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«" required>
      <div>
        <label><input type="radio" name="search_mode" value="and" checked> Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (AND)</label>
        <label><input type="radio" name="search_mode" value="or"> Ø£ÙŠ ÙƒÙ„Ù…Ø© (OR)</label>
      </div>
      <button type="submit">ğŸ” Ø¨Ø­Ø«</button>
    </form>
    <hr>
    {% for folder, filename in books %}
      <a href="{{ url_for('view_book', folder=folder, filename=filename) }}"
         class="{% if folder == current_folder and filename == current_filename %}active-book{% endif %}">
        {{ folder }}/{{ filename.rsplit('.', 1)[0] }}
      </a>
    {% endfor %}
  </div>

  <script>
    let currentPages = [];
    let currentPageIndex = 0;
    let fontSize = 17;
    let currentBookTitle = "";

    function setBookTitle(title) {
      currentBookTitle = title;
      document.querySelector('.book-title').textContent = title;
    }

    function showPage(index) {
      const container = document.getElementById("display-area");
      if (currentPages.length > 0) {
        container.innerHTML = currentPages[index];
        currentPageIndex = index;

        document.getElementById("prev-btn").disabled = (index === 0);
        document.getElementById("next-btn").disabled = (index === currentPages.length - 1);

        document.getElementById("page-number").innerText = `ğŸ“„ Ø§Ù„ØµÙØ­Ø© ${index + 1}`;
      }
    }

    function nextPage() {
      if (currentPageIndex < currentPages.length - 1) {
        showPage(currentPageIndex + 1);
      }
    }

    function prevPage() {
      if (currentPageIndex > 0) {
        showPage(currentPageIndex - 1);
      }
    }

    function loadBookPages(pages, pageIndex) {
      currentPages = pages;
      showPage(pageIndex);
    }

    function handleSnippetClick(element) {
      document.querySelectorAll('.snippet').forEach(el => {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
    }

    function adjustFontSize(change) {
      fontSize += change;
      document.getElementById("display-area").style.fontSize = fontSize + "px";
    }

    function copyWithMeta() {
      const selection = window.getSelection().toString().trim();
      const fullText = currentPages[currentPageIndex];
      const pageInfo = document.getElementById("page-number").innerText;
      const bookTitle = currentBookTitle || document.querySelector('.book-title').textContent;

      const textToCopy = selection || fullText;
      const finalText = `${textToCopy}\n\nğŸ“˜ Ø§Ù„ÙƒØªØ§Ø¨: ${bookTitle}\n${pageInfo}`;

      navigator.clipboard.writeText(finalText)
        .then(() => alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­"))
        .catch(() => alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®"));
    }
  </script>
</body>
</html>